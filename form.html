<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Form with Login</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
    <style>
        body {
            background-color: #f8f9fa; /* Soft background */
        }
        
        #welcome-message {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            font-size: 16px;
            border-radius: 5px;
            z-index: 1000;
        }

        #formContainer {
            display: none; /* Hide form initially */
        }

        /* Custom styles for error message */
        #messageBox {
            display: none;
            padding: 20px;
            border-radius: 5px;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
        }
    </style>
</head>

<body>
    <div id="welcome-message" style="display: none;"></div>

    <div class="container mt-5" id="formContainer">
        <div class="form-div">
            <form id="formData" method="post" class="border p-4 bg-light">
                <h2 class="text-center">Form</h2>
                <input type="hidden" id="publisher_id" name="publisher_id" value="7f948b38" />
                <input type="hidden" id="key" name="key" value="76fa0b92-10e9-4138-8043-8fda1eab561d" />

                <div class="form-group">
                    <label for="caller_number">Caller Number</label>
                    <input type="text" class="form-control" id="caller_number" name="caller_number" placeholder="Caller Number" required />
                </div>

                <div class="form-group">
                    <label for="first_name">First Name</label>
                    <input type="text" class="form-control" id="first_name" name="first_name" placeholder="First Name" required />
                </div>

                <div class="form-group">
                    <label for="last_name">Last Name</label>
                    <input type="text" class="form-control" id="last_name" name="last_name" placeholder="Last Name" required />
                </div>

                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" class="form-control" id="email" name="email" placeholder="Email" required />
                </div>

                <div class="form-group">
                    <label for="caller_state">State</label>
                    <input type="text" class="form-control" id="caller_state" name="caller_state" placeholder="State" required />
                </div>

                <div class="form-group">
                    <label for="caller_zip">Zip Code</label>
                    <input type="text" class="form-control" id="caller_zip" name="caller_zip" placeholder="Zip Code" required />
                </div>

                <div class="form-group">
                    <label for="attorney">Attorney</label>
                    <input type="text" class="form-control" id="attorney" name="attorney" placeholder="Attorney" required />
                </div>

                <div class="form-group">
                    <label for="incident_date">Incident Date</label>
                    <input type="date" class="form-control" id="incident_date" name="incident_date" required />
                </div>

                <div class="form-group">
                    <label for="injured">Injured</label>
                    <input type="text" class="form-control" id="injured" name="injured" placeholder="Injured" required />
                </div>

                <div class="form-group">
                    <label for="trusted_form_cert_url">Certificate URL</label>
                    <input type="url" class="form-control" id="trusted_form_cert_url" name="trusted_form_cert_url" placeholder="Certificate URL" required />
                </div>

                <button type="submit" class="btn btn-primary mt-3">Submit</button>
            </form>
        </div>
    </div>

    <div id="messageBox">
        <p id="messageText" style="margin: 0"></p>
    </div>

    <script>
        $(document).ready(function () {
            const companyName = "803 ACA WT - TEST"; // Replace with the real company name

            // Show the welcome message
            function showWelcomeMessage(companyName) {
                const welcomeMessageDiv = document.getElementById('welcome-message');
                welcomeMessageDiv.textContent = `Welcome, ${companyName}`;
                welcomeMessageDiv.style.display = 'block';
            }

            // Show SweetAlert welcome message
            function showGreetingAlert() {
                Swal.fire({
                    title: `Welcome, ${companyName}`,
                    text: "We're glad to have you here!",
                    icon: 'success',
                    confirmButtonText: 'Proceed to Login',
                    timer: 3000, // 3 seconds
                    timerProgressBar: true,
                }).then(() => {
                    showLoginPrompt(); // Call the login prompt after greeting
                });
            }

            // Validate email
            function validateEmail(email) {
                const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return re.test(String(email).toLowerCase());
            }

            // Validate password (at least 8 characters and with uppercase)
            function validatePassword(password) {
                const re = /^(?=.*[A-Z])(?=.*[0-9]).{8,}$/; // Without special character
                return re.test(String(password));
            }

            // Show SweetAlert for username and password
            function showLoginPrompt() {
                Swal.fire({
                    title: 'Login Required',
                    html:
                        '<input type="email" id="username" class="swal2-input" placeholder="Email">' +
                        '<input type="password" id="password" class="swal2-input" placeholder="Password">',
                    showCancelButton: false,
                    confirmButtonText: 'Login',
                    focusConfirm: false,
                    preConfirm: () => {
                        const username = Swal.getPopup().querySelector('#username').value;
                        const password = Swal.getPopup().querySelector('#password').value;

                        if (!validateEmail(username)) {
                            Swal.showValidationMessage(`Please enter a valid email.`);
                        }
                        if (!validatePassword(password)) {
                            Swal.showValidationMessage(
                                `Password must be at least 8 characters long and contain at least one uppercase letter and one number.`
                            );
                        }

                        return { username: username, password: password };
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Verify credentials
                        if (result.value.username === "prueba@gmail.com" && result.value.password === "A1234567") {
                            $('#formContainer').show(); // Show the form if credentials are correct
                            showWelcomeMessage(companyName); // Show welcome message
                        } else {
                            Swal.fire('Error', 'Invalid credentials', 'error');
                            showLoginPrompt(); // Show the prompt again if credentials are incorrect
                        }
                    }
                });
            }

            // Show initial greeting when the page loads
            showGreetingAlert();

            // Form submission handler
            document.querySelector("#formData").addEventListener("submit", async (event) => {
                event.preventDefault();

                const formData = new FormData(event.target);
                const data = Object.fromEntries(formData.entries());

                try {
                    const response = await fetch("/api/proxy", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify(data),
                    });

                    if (response.ok) {
                        const result = await response.json();
                        // Handle server response
                        showMessage(`Form submitted successfully: ${result.message}`, "success");
                    } else {
                        const errorText = await response.text();
                        showMessage(`Error: ${errorText}`, "error");
                    }
                } catch (error) {
                    showMessage(`Error submitting form: ${error}`, "error");
                }
            });

            // Show custom message
            function showMessage(text, type) {
                const messageBox = document.getElementById('messageBox');
                const messageText = document.getElementById('messageText');

                messageText.textContent = text;
                messageBox.style.display = 'block';
                messageBox.style.backgroundColor = type === "success" ? "#4CAF50" : "#f44336"; // Green or red

                setTimeout(() => {
                    messageBox.style.display = 'none';
                }, 3000); // Hide after 3 seconds
            }
        });
    </script>
</body>
</html>
